name: banking
services:
  postgres:
    image: postgres:18.1
    volumes:
      - postgres-data:/var/lib/postgresql
    ports:
      - 5432:5432
    configs:
      - source: postgres-init-config
        target: /docker-entrypoint-initdb.d/banking-init.sh
    env_file: ./env/postgres.env
  liquibase-accounts:
    depends_on:
      - postgres
    image: vl4ds4m/liquibase-postgres:5.0.1
    command:
      - "update"
    configs:
      - source: liquibase-accounts-changelog-root-config
        target: /liquibase/changelog-root.yaml
      - source: liquibase-accounts-changelog-def-config
        target: /liquibase/changelog-def.yaml
      - source: liquibase-accounts-changelog-data-config
        target: /liquibase/changelog-data.yaml
    env_file: ./env/liquibase-accounts.env
  mongo:
    image: mongo:8.0.12
    volumes:
      - mongo-data:/data/db
    ports:
      - 27017:27017
  redis:
    image: redis:8.4.0
    ports:
      - 6379:6379
  kafka:
    image: apache/kafka:4.1.1
    ports:
      - 9094:9094
    env_file: ./env/kafka.env
  keycloak:
    depends_on:
      - postgres
    image: quay.io/keycloak/keycloak:26.5.0
    command:
      - "start-dev"
      - "--import-realm"
    ports:
      - 8084:8080
    secrets:
      - source: keycloak-config
        target: /opt/keycloak/conf/keycloak.conf
      - source: keycloak-realm
        target: /opt/keycloak/data/import/realm.json
  proxy:
    image: nginx:1.29.4
    ports:
      - 80:80
    configs:
      - source: proxy-config
        target: /etc/nginx/conf.d/default.conf
    links:
      - keycloak
      - webui
    networks:
      default:
        aliases:
          - "banking.local"
  rates:
    depends_on:
      - keycloak
    build:
      args:
        - JAR_FILE=./build/rates.jar
    ports:
      - 8083:8080
      - 9093:9090
    configs:
      - source: rates-source-config
        target: /rates-info.yaml
    env_file: ./env/rates.env
  converter:
    depends_on:
      - keycloak
    build:
      args:
        - JAR_FILE=./build/converter.jar
    ports:
      - 8082:8080
      - 9092:9090
    env_file: ./env/converter.env
  accounts:
    depends_on:
      - postgres
      - keycloak
      - redis
      - kafka
    build:
      args:
        - JAR_FILE=./build/accounts.jar
    ports:
      - 8081:8080
    env_file: ./env/accounts.env
  webui:
    depends_on:
      - keycloak
    build:
      args:
        - JAR_FILE=./build/web-ui.jar
    ports:
      - 8085:8080
    env_file: ./env/web-ui.env
  transactions:
    depends_on:
      - mongo
      - kafka
    build:
      args:
        - JAR_FILE=./build/transactions.jar
    ports:
      - 8086:8080
    env_file: ./env/transactions.env
#  test-box:
#    depends_on:
#      - converter
#      - accounts
#    image: miraclewisp/hse-accounts-test:amd64
#    command: ["-ws", "-fail", "-idmp"]
#    env_file: ./env/test-box.env
volumes:
  postgres-data: {}
  mongo-data: {}
secrets:
  keycloak-config:
    file: ./config/keycloak.conf
  keycloak-realm:
    file: ./config/realm.json
configs:
  postgres-init-config:
    file: ./config/postgres-init.sh
  liquibase-accounts-changelog-root-config:
    file: ./config/liquibase-accounts/changelog-root.yaml
  liquibase-accounts-changelog-def-config:
    file: ./config/liquibase-accounts/changelog-def.yaml
  liquibase-accounts-changelog-data-config:
    file: ./config/liquibase-accounts/changelog-data.yaml
  proxy-config:
    file: ./config/proxy.conf
  rates-source-config:
    file: ./config/rates-src.yaml
