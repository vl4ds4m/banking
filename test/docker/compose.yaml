name: banking
services:
  postgres:
    image: postgres:18
    volumes:
      - postgres-data:/var/lib/postgresql
    ports:
      - 5432:5432
    env_file: ./env/postgres.env
  mongo:
    image: mongo:8.0.12
    volumes:
      - mongo-data:/data/db
    ports:
      - 27017:27017
  redis:
    image: redis:8
    ports:
      - 6379:6379
  kafka:
    image: apache/kafka:4.1.1
    ports:
      - 9094:9094
    env_file: ./env/kafka.env
#  keycloak:
#    image: quay.io/keycloak/keycloak:23.0.6
#    command: ["start-dev", "--import-realm"]
#    ports:
#      - 8084:8080
#    secrets:
#      - source: keycloak-realm
#        target: /opt/keycloak/data/import/realm.json
#    env_file: ./env/keycloak.env
  rates:
#    depends_on:
#      - keycloak
    image: miraclewisp/hse-rates:amd64
    ports:
      - 8083:8080
    env_file: ./env/rates.env
  converter:
    depends_on:
#      - keycloak
      - rates
    build:
      args:
        - JAR_FILE=./build/converter.jar
    ports:
      - 8082:8080
    configs:
      - source: converter-config
        target: /application.yaml
    env_file: ./env/converter.env
  accounts:
    depends_on:
      - converter
      - postgres
      - redis
      - kafka
    build:
      args:
        - JAR_FILE=./build/accounts.jar
    ports:
      - 8081:8080
    env_file: ./env/accounts.env
  webui:
    build:
      args:
        - JAR_FILE=./build/web-ui.jar
    ports:
      - 8085:8080
    env_file: ./env/web-ui.env
  transactions:
    depends_on:
      - mongo
      - kafka
    build:
      args:
        - JAR_FILE=./build/transactions.jar
    ports:
      - 8086:8080
    env_file: ./env/transactions.env
#  test-box:
#    depends_on:
#      - converter
#      - accounts
#    image: miraclewisp/hse-accounts-test:amd64
#    command: ["-ws", "-fail", "-idmp"]
#    env_file: ./env/test-box.env
volumes:
  postgres-data: {}
  mongo-data: {}
#secrets:
#  keycloak-realm:
#    file: ./config/realm.json
configs:
  converter-config:
    file: ./config/converter.yaml
