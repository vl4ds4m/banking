name: banking
services:
  postgres:
    image: postgres:18
    volumes:
      - postgres-data:/var/lib/postgresql
    ports:
      - 5432:5432
    env_file: ./env/postgres.env
#  redis:
#    image: redis:8
#    ports:
#      - 6379:6379
#  keycloak:
#    image: quay.io/keycloak/keycloak:23.0.6
#    command: ["start-dev", "--import-realm"]
#    ports:
#      - 8084:8080
#    secrets:
#      - source: keycloak-realm
#        target: /opt/keycloak/data/import/realm.json
#    env_file: ./env/keycloak.env
  rates:
#    depends_on:
#      - keycloak
    image: miraclewisp/hse-rates:amd64
    ports:
      - 8083:8080
    env_file: ./env/rates.env
  converter:
    depends_on:
#      - keycloak
      - rates
    build:
      args:
        - JAR_FILE=./build/converter.jar
    ports:
      - 8082:8080
    configs:
      - source: converter-config
        target: /application.yaml
    env_file: ./env/converter.env
  accounts:
    depends_on:
      - converter
      - postgres
#      - redis
    build:
      args:
        - JAR_FILE=./build/accounts.jar
    ports:
      - 8081:8080
    configs:
      - source: accounts-config
        target: /application.yaml
    env_file: ./env/accounts.env
#  test-box:
#    depends_on:
#      - converter
#      - accounts
#    image: miraclewisp/hse-accounts-test:amd64
#    command: ["-ws", "-fail", "-idmp"]
#    env_file: ./env/test-box.env
volumes:
  postgres-data: {}
#secrets:
#  keycloak-realm:
#    file: ./config/realm.json
configs:
  converter-config:
    file: ./config/converter.yaml
  accounts-config:
    file: ./config/accounts.yaml
